# Функциональные требования к дашборду статистики

## Обзор

Дашборд предназначен для визуализации статистики по диалогам Telegram-бота с LLM-ассистентом. Интерфейс должен предоставлять быстрый обзор ключевых метрик и детальную информацию об активности пользователей.

## Референс дизайна

Референсный дизайн: `frontend/doc/frontend-reference.jpg`
Источник: https://ui.shadcn.com/blocks#dashboard-01

## Метрики дашборда

### 1. Карточки метрик (Metrics Cards)

Дашборд содержит 4 карточки с ключевыми метриками, каждая из которых отображает:
- Название метрики
- Текущее значение
- Тренд (процентное изменение относительно предыдущего периода)
- Индикатор направления тренда (↑ рост, ↓ снижение)
- Краткое описание/пояснение

#### Метрика 1: Total Conversations (Всего диалогов)

**Описание**: Общее количество диалогов за выбранный период

**Бизнес-контекст**:
- Один пользователь может иметь несколько диалогов
- Диалог создается при первом сообщении пользователя
- Каждый диалог имеет уникальный conversation_id

**Отображение**:
- Значение: количество записей в таблице `conversations`
- Тренд: изменение относительно предыдущего аналогичного периода
- Пример: "1,234" с трендом "+12.5%"

#### Метрика 2: New Users (Новые пользователи)

**Описание**: Количество уникальных пользователей, впервые начавших диалог за период

**Бизнес-контекст**:
- Считаются пользователи, создавшие первый диалог в выбранном периоде
- Определяется по минимальной дате created_at для каждого user_id

**Отображение**:
- Значение: количество новых уникальных user_id
- Тренд: изменение относительно предыдущего периода
- Пример: "234" с трендом "-20%"

#### Метрика 3: Active Conversations (Активные диалоги)

**Описание**: Количество диалогов с активностью (сообщениями) за период

**Бизнес-контекст**:
- Диалог считается активным, если в нем было хотя бы одно сообщение в выбранном периоде
- Проверяется наличие записей в `user_messages` или `llm_responses` с timestamp в периоде

**Отображение**:
- Значение: количество активных диалогов
- Тренд: изменение относительно предыдущего периода
- Пример: "45,678" с трендом "+12.5%"

#### Метрика 4: Average Messages per Conversation (Среднее сообщений на диалог)

**Описание**: Среднее количество пользовательских сообщений на один диалог

**Бизнес-контекст**:
- Показатель вовлеченности пользователей
- Считаются только сообщения пользователей (user_messages), не ответы LLM
- Рассчитывается для диалогов с активностью в выбранном периоде

**Отображение**:
- Значение: среднее с точностью до десятых (например, "4.5")
- Тренд: изменение относительно предыдущего периода
- Пример: "4.5" с трендом "+4.5%"

### 2. График активности (Activity Chart)

**Описание**: Временной ряд, отображающий динамику активности сообщений

**Данные**:
- Ось X: временные метки (дата/время)
- Ось Y: количество сообщений
- Визуализация: area chart (график с заливкой)

**Гранулярность данных по периодам**:
- **Day** (День): почасовая статистика (24 точки)
- **Week** (Неделя): посуточная статистика (7 точек)
- **Month** (Месяц): посуточная статистика (30-31 точка)

**Интерактивность**:
- Переключение между периодами через кнопки/табы
- При наведении на точку - отображение точного значения и времени

### 3. Список последних диалогов (Recent Conversations)

**Описание**: Таблица с последними 10 диалогами, отсортированными по времени последней активности

**Колонки**:
- **Conversation ID**: идентификатор диалога
- **User ID**: идентификатор пользователя
- **Messages**: количество сообщений в диалоге
- **Last Activity**: время последнего сообщения (относительное, например "2 hours ago")
- **Created**: время создания диалога (дата)

**Сортировка**: по убыванию времени последней активности (самые свежие сверху)

### 4. Топ пользователей (Top Users)

**Описание**: Список 5 наиболее активных пользователей за период

**Данные**:
- **User ID**: идентификатор пользователя
- **Messages**: общее количество отправленных сообщений
- **Conversations**: количество диалогов пользователя

**Сортировка**: по убыванию количества сообщений

## Фильтрация по периодам

### Поддерживаемые периоды

1. **Day** (День): последние 24 часа от текущего момента
2. **Week** (Неделя): последние 7 дней
3. **Month** (Месяц): последние 30 дней

### Механизм фильтрации

- Переключатель периодов в виде кнопок/табов
- При смене периода обновляются все метрики и график
- По умолчанию: Week (7 дней)

## UI/UX требования

### Визуальный стиль

- Темная тема (как в референсе)
- Карточки с rounded corners и subtle shadow
- Монохромная цветовая схема с акцентами
- Читаемые шрифты (sans-serif)

### Индикаторы трендов

- Зеленый цвет для положительных трендов (↑)
- Красный цвет для отрицательных трендов (↓)
- Процент изменения с одним знаком после запятой

### Отзывчивость

- Адаптивная верстка для десктопов (приоритет)
- Graceful degradation для планшетов
- Минимальная ширина экрана: 1024px

### Производительность

- Время загрузки данных: < 500ms
- Плавные переходы при смене периодов
- Lazy loading для списка диалогов при необходимости

## Ограничения текущей версии

**Что НЕ включено в MVP**:
- Детальный просмотр отдельного диалога
- Экспорт данных
- Настройка кастомных периодов
- Фильтрация по пользователям
- Real-time обновление данных
- Аналитика по использованию различных моделей LLM
- Статистика по длине сообщений

## Технические требования к API

### Эндпоинт

```
GET /api/stats?period={period}
```

**Параметры**:
- `period`: string, один из ["day", "week", "month"]

**Формат ответа**: JSON

### Структура данных

```json
{
  "metrics": [
    {
      "title": "Total Conversations",
      "value": "1,234",
      "trend": 12.5,
      "trend_label": "Trending up this month",
      "description": "Visitors for the last 6 months"
    },
    // ... еще 3 метрики
  ],
  "activity_chart": [
    {
      "timestamp": "2025-10-17T00:00:00Z",
      "value": 145
    },
    // ... остальные точки
  ],
  "recent_conversations": [
    {
      "conversation_id": 123,
      "user_id": 456789,
      "messages_count": 15,
      "last_activity": "2025-10-17T14:30:00Z",
      "created_at": "2025-10-15T10:20:00Z"
    },
    // ... до 10 элементов
  ],
  "top_users": [
    {
      "user_id": 789012,
      "messages_count": 245,
      "conversations_count": 12
    },
    // ... до 5 элементов
  ],
  "period": "week"
}
```

## Примеры использования

### Сценарий 1: Мониторинг общей активности
Администратор открывает дашборд и видит общую картину активности за неделю, быстро оценивая тренды.

### Сценарий 2: Анализ падения активности
Администратор замечает отрицательный тренд в метрике "New Users", переключается на период "Month" для оценки долгосрочной динамики.

### Сценарий 3: Выявление активных пользователей
Администратор просматривает топ-5 пользователей для понимания паттернов использования бота.

## Соответствие существующей архитектуре

Дашборд использует данные из существующих таблиц:
- `conversations` - информация о диалогах
- `user_messages` - сообщения пользователей
- `llm_responses` - ответы ассистента

Не требуется изменения схемы БД для реализации этих метрик.
