# Tasklist: SPRINT-1 - Persistent Storage

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ Completed (2025-10-16)
> **–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –≤ PostgreSQL

---

## üìã –û–±–∑–æ—Ä —Å–ø—Ä–∏–Ω—Ç–∞

**–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞:** –ó–∞–º–µ–Ω–∏—Ç—å in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (`HistoryStorage`) –Ω–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLAlchemy Core –∏ Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- KISS - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ—à–µ–Ω–∏—è
- Async/await - –ø–æ–ª–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- Repository pattern - —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- Soft delete - –¥–∞–Ω–Ω—ã–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ, –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏
- Test coverage - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 95%+ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- [x] –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ –±–æ—Ç–∞
- [x] Test coverage –æ—Å—Ç–∞–µ—Ç—Å—è >= 95%
- [x] –í—Å–µ –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (README, ADR, vision, idea, roadmap)
- [x] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ

---

## üìù –ó–∞–¥–∞—á–∏ —Å–ø—Ä–∏–Ω—Ç–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 1.1. –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
- [x] –ò–∑—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `HistoryStorage`
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ (CRUD)
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ soft delete
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Repository

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Repository

#### 1.2. –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- [x] –°—Ä–∞–≤–Ω–∏—Ç—å SQLite vs PostgreSQL vs MongoDB
- [x] –í—ã–±—Ä–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π (Alembic)
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –≤ ADR-001
- [x] –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤—ã–±–æ—Ä PostgreSQL

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** [ADR-001: Database and Migrations](../adr/001-database-and-migrations.md)

#### 1.3. –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `conversations`
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_messages`
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `llm_responses`
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤—è–∑–∏ (Foreign Keys)
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è soft delete (is_deleted)
- [x] –î–æ–±–∞–≤–∏—Ç—å timestamps (created_at, updated_at)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ö–µ–º–∞ –ë–î –≥–æ—Ç–æ–≤–∞ (3 —Ç–∞–±–ª–∏—Ü—ã, —Å–≤—è–∑–∏, –∏–Ω–¥–µ–∫—Å—ã)

---

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

#### 2.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL —á–µ—Ä–µ–∑ Docker
- [x] –°–æ–∑–¥–∞—Ç—å `docker-compose.yml`
  - PostgreSQL 16 alpine
  - –ü–æ—Ä—Ç 5433 (–∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º PostgreSQL)
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–∞—Ä–æ–ª—å, –ë–î: aidd
  - Volume –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
  - Healthcheck –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ Makefile:
  - `make db-up` - –∑–∞–ø—É—Å–∫ PostgreSQL
  - `make db-down` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
  - `make db-reset` - –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ë–î
- [x] –û–±–Ω–æ–≤–∏—Ç—å `.gitignore` (data/, *.db, *.db-journal)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Docker Compose –Ω–∞—Å—Ç—Ä–æ–µ–Ω, Makefile –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç

#### 2.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] –î–æ–±–∞–≤–∏—Ç—å `asyncpg>=0.29.0` –≤ `pyproject.toml`
- [x] –û–±–Ω–æ–≤–∏—Ç—å `.env.example` —Å `DATABASE_URL`
- [x] –î–æ–±–∞–≤–∏—Ç—å `DATABASE_URL` –≤ `Config`
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å `uv sync` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞

#### 2.3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alembic
- [x] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Alembic: `uv run alembic init alembic`
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `alembic.ini` (—É–±—Ä–∞—Ç—å hardcoded URL)
- [x] –û–±–Ω–æ–≤–∏—Ç—å `alembic/env.py`:
  - –ò–º–ø–æ—Ä—Ç Config –∏ metadata
  - –ó–∞–≥—Ä—É–∑–∫–∞ DATABASE_URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ async –º–∏–≥—Ä–∞—Ü–∏–π
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ Makefile:
  - `make db-migrate` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
  - `make db-revision` - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Alembic –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è async –º–∏–≥—Ä–∞—Ü–∏–π

---

### 3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ—è –¥–∞–Ω–Ω—ã—Ö

#### 3.1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î (src/database.py)
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å `metadata` –¥–ª—è SQLAlchemy Core
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `conversations`:
  - id (PK, autoincrement)
  - user_id (BigInteger, index) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å Integer
  - system_prompt (Text)
  - created_at, updated_at (DateTime)
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_messages`:
  - id (PK, autoincrement)
  - conversation_id (FK, cascade delete, index)
  - user_id (BigInteger, index)
  - text (Text)
  - content_length (Integer)
  - timestamp (DateTime)
  - is_deleted (Boolean, default False, index)
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `llm_responses`:
  - id (PK, autoincrement)
  - conversation_id (FK, cascade delete, index)
  - content (Text)
  - content_length (Integer)
  - model_used (String)
  - timestamp (DateTime)
  - is_deleted (Boolean, default False, index)
- [x] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `create_engine()` –¥–ª—è AsyncEngine

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `src/database.py` —Å –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º–æ–π –ë–î

#### 3.2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- [x] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `make db-revision name="initial schema"`
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `make db-migrate`
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –≤ PostgreSQL

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–≥—Ä–∞—Ü–∏—è `0f132edeb3b2_initial_schema` —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

#### 3.3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è DatabaseHistoryStorage
- [x] –°–æ–∑–¥–∞—Ç—å `src/db_history_storage.py`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `__init__(engine, max_history)`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `get_or_create_context(user_id, system_prompt)`:
  - –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ conversation
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
  - –ó–∞–≥—Ä—É–∑–∫–∞ messages –∏ responses (—Ç–æ–ª—å–∫–æ is_deleted=False)
  - –í–æ–∑–≤—Ä–∞—Ç ConversationContext
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `add_message(user_id, text, system_prompt)`:
  - get_or_create_context
  - –í—Å—Ç–∞–≤–∫–∞ message
  - –í—ã–∑–æ–≤ _trim_history
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `add_response(user_id, content, model)`:
  - –ü–æ–ª—É—á–µ–Ω–∏–µ conversation_id
  - –í—Å—Ç–∞–≤–∫–∞ response
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at
  - –í—ã–∑–æ–≤ _trim_history
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `get_context(user_id)`:
  - –ü–æ–∏—Å–∫ conversation
  - –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ get_or_create_context
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `clear(user_id)` (soft delete):
  - –ù–∞–π—Ç–∏ conversation_id
  - UPDATE is_deleted=True –¥–ª—è –≤—Å–µ—Ö messages
  - UPDATE is_deleted=True –¥–ª—è –≤—Å–µ—Ö responses
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async `_trim_history(conversation_id)` (soft delete):
  - –ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö messages
  - Soft delete —Å—Ç–∞—Ä—ã—Ö messages –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ max_history
  - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è responses

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `DatabaseHistoryStorage` —Å –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π Repository pattern

---

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

#### 4.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ConversationManager
- [x] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É DatabaseHistoryStorage –≤ type hints
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ storage –¥–ª—è async/sync –≤—ã–∑–æ–≤–æ–≤
- [x] –û–±–Ω–æ–≤–∏—Ç—å `process_message()`:
  - await storage.add_message() –¥–ª—è DatabaseHistoryStorage
  - await storage.get_context()
  - await storage.add_response()
- [x] –û–±–Ω–æ–≤–∏—Ç—å `clear_history()`:
  - await storage.clear()

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ConversationManager –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ç–∏–ø–∞ storage

#### 4.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ main.py
- [x] –ò–º–ø–æ—Ä—Ç `create_engine` –∏–∑ `src.database`
- [x] –ò–º–ø–æ—Ä—Ç `DatabaseHistoryStorage`
- [x] –°–æ–∑–¥–∞–Ω–∏–µ AsyncEngine –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- [x] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DatabaseHistoryStorage —Å engine
- [x] –ü–µ—Ä–µ–¥–∞—á–∞ –≤ ConversationManager
- [x] Graceful shutdown: `await engine.dispose()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

#### 4.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ TelegramBot
- [x] –û–±–Ω–æ–≤–∏—Ç—å `cmd_clear()`: `await self.conversation_manager.clear_history()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å async storage

---

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 5.1. Unit —Ç–µ—Å—Ç—ã –¥–ª—è DatabaseHistoryStorage
- [x] –°–æ–∑–¥–∞—Ç—å `tests/test_db_history_storage.py`
- [x] –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É `test_db_engine` (SQLite in-memory)
- [x] –¢–µ—Å—Ç: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DatabaseHistoryStorage
- [x] –¢–µ—Å—Ç: add_message —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- [x] –¢–µ—Å—Ç: add_response —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç
- [x] –¢–µ—Å—Ç: trim_history –æ–±—Ä–µ–∑–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (soft delete)
- [x] –¢–µ—Å—Ç: clear –ø–æ–º–µ—á–∞–µ—Ç –≤—Å–µ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ (soft delete)
- [x] –¢–µ—Å—Ç: get_context –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ user
- [x] –¢–µ—Å—Ç: get_or_create_context —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- [x] –¢–µ—Å—Ç: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 8 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤, –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç

#### 5.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–∏—Ç—å `tests/conftest.py`:
  - –î–æ–±–∞–≤–∏—Ç—å `pytest-asyncio`
  - –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É `test_db_engine`
- [x] –û–±–Ω–æ–≤–∏—Ç—å `tests/test_conversation_manager.py`:
  - `await clear_history()`
- [x] –û–±–Ω–æ–≤–∏—Ç—å `tests/test_telegram_bot.py`:
  - Mock `clear_history` –∫–∞–∫ AsyncMock
- [x] –û–±–Ω–æ–≤–∏—Ç—å `tests/test_main.py`:
  - Mock `create_engine` –∏ `DatabaseHistoryStorage`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `engine.dispose()` –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ç–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç

#### 5.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ coverage
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å `make test`
- [x] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ coverage >= 95%
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:
  - `src/database.py` >= 85%
  - `src/db_history_storage.py` >= 95%

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 69 —Ç–µ—Å—Ç–æ–≤, 95% coverage ‚úÖ

#### 5.4. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL: `make db-up`
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: `make db-migrate`
- [x] –°–æ–∑–¥–∞—Ç—å `.env` —Å —Ç–æ–∫–µ–Ω–∞–º–∏
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: `uv run python -m src`
- [x] –¢–µ—Å—Ç 1: –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` - –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å
- [x] –¢–µ—Å—Ç 2: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å —á–µ—Ä–µ–∑ LLM
- [x] –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç - –±–æ—Ç –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [x] –¢–µ—Å—Ç 4: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ (Ctrl+C)
- [x] –¢–µ—Å—Ç 5: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å–Ω–æ–≤–∞
- [x] –¢–µ—Å—Ç 6: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é! ‚úÖ
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:
  ```bash
  docker exec aidd-postgres psql -U aidd -d aidd \
    -c "SELECT * FROM conversations;"
  docker exec aidd-postgres psql -U aidd -d aidd \
    -c "SELECT id, text, content_length FROM user_messages;"
  ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç! –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏.

---

### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤

#### 6.1. –ë–∞–≥: user_id –ø—Ä–µ–≤—ã—à–∞–µ—Ç Integer (int32)
**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram user_id = 5198055406 > 2147483647 (max int32)
```
asyncpg.exceptions.DataError: invalid input for query argument $1:
5198055406 (value out of int32 range)
```

**–†–µ—à–µ–Ω–∏–µ:**
- [x] –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø `user_id` —Å `Integer` –Ω–∞ `BigInteger` –≤ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- [x] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `make db-revision name="change user_id to bigint"`
- [x] –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î: `make db-reset`
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: `make db-migrate`
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `docker exec aidd-postgres psql -U aidd -d aidd -c "\d conversations"`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–≥—Ä–∞—Ü–∏—è `bd7b2d0ee30e_change_user_id_to_bigint` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úÖ

---

### 7. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### 7.1. –°–æ–∑–¥–∞–Ω–∏–µ ADR-001
- [x] –°–æ–∑–¥–∞—Ç—å `docs/adr/001-database-and-migrations.md`
- [x] –û–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- [x] –°—Ä–∞–≤–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã (SQLite vs PostgreSQL vs MongoDB)
- [x] –û–±–æ—Å–Ω–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä PostgreSQL
- [x] –û–ø–∏—Å–∞—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏ —Ä–∏—Å–∫–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ADR-001 —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

#### 7.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.md
- [x] –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
- [x] –î–æ–±–∞–≤–∏—Ç—å PostgreSQL, SQLAlchemy, Alembic –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å Docker Compose –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã Makefile (db-*)
- [x] –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** README –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

#### 7.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ vision.md
- [x] –î–æ–±–∞–≤–∏—Ç—å PostgreSQL, SQLAlchemy, Alembic –≤ —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- [x] –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞
- [x] –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∞—Å—Å–æ–≤ (DatabaseHistoryStorage)
- [x] –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è: —Å in-memory –Ω–∞ PostgreSQL
- [x] –£–±—Ä–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ "–Ω–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** vision.md –æ–±–Ω–æ–≤–ª–µ–Ω

#### 7.4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ idea.md
- [x] –ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å MVP –Ω–∞ v1.1
- [x] –î–æ–±–∞–≤–∏—Ç—å PostgreSQL –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- [x] –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (DatabaseHistoryStorage, Database)
- [x] –û—Ç–º–µ—Ç–∏—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é
- [x] –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è (v1.2)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** idea.md –æ–±–Ω–æ–≤–ª–µ–Ω

#### 7.5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ roadmap.md
- [x] –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å SPRINT-1 –Ω–∞ "Completed"
- [x] –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ ADR-001
- [x] –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ tasklist-sprint-1.md
- [x] –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: 2/2 —Å–ø—Ä–∏–Ω—Ç–∞ (100%)
- [x] –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è Sprint-1"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** roadmap.md –æ–±–Ω–æ–≤–ª–µ–Ω

#### 7.6. –°–æ–∑–¥–∞–Ω–∏–µ tasklist-sprint-1.md
- [x] –°–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ø–ª–∞–Ω–æ–º —Å–ø—Ä–∏–Ω—Ç–∞
- [x] –û–ø–∏—Å–∞—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–≥–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚úÖ

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –ö–æ–¥
- **–§–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã:** 3
  - `src/database.py` (—Å—Ö–µ–º–∞ –ë–î)
  - `src/db_history_storage.py` (Repository)
  - `tests/test_db_history_storage.py` (—Ç–µ—Å—Ç—ã)
- **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** 10+
  - `src/main.py`, `src/config.py`, `src/conversation_manager.py`
  - `src/telegram_bot.py`, `tests/conftest.py`
  - `pyproject.toml`, `docker-compose.yml`, `alembic.ini`
  - `.env.example`, `.gitignore`, `Makefile`, `README.md`

### –ú–∏–≥—Ä–∞—Ü–∏–∏
- **–ú–∏–≥—Ä–∞—Ü–∏—è 1:** `0f132edeb3b2_initial_schema` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
- **–ú–∏–≥—Ä–∞—Ü–∏—è 2:** `bd7b2d0ee30e_change_user_id_to_bigint` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞

### –¢–µ—Å—Ç—ã
- **–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã:** 8
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 69
- **Coverage:** 95%
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ~5 —Å–µ–∫—É–Ω–¥

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **–¢–∞–±–ª–∏—Ü—ã:** 3 (conversations, user_messages, llm_responses)
- **–ò–Ω–¥–µ–∫—Å—ã:** 6 (user_id, conversation_id, is_deleted)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** 2
- **Soft delete:** ‚úÖ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø—Ä–∏–Ω—Ç–∞

‚úÖ **SPRINT-1 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**

**–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ:**
1. ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
2. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ (—Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ)
3. ‚úÖ Soft delete —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ Repository pattern –ø—Ä–∏–º–µ–Ω–µ–Ω (DatabaseHistoryStorage)
5. ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (async/await –≤–µ–∑–¥–µ)
6. ‚úÖ Test coverage = 95% (—Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞)
7. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∞
8. ‚úÖ ADR-001 —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω
9. ‚úÖ Docker Compose –Ω–∞—Å—Ç—Ä–æ–µ–Ω
10. ‚úÖ Makefile –∫–æ–º–∞–Ω–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

**–ë–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
- ‚úÖ BigInteger –¥–ª—è Telegram user_id

**–ö–∞—á–µ—Å—Ç–≤–æ:**
- 69 —Ç–µ—Å—Ç–æ–≤ passed ‚úÖ
- 95% coverage ‚úÖ
- 0 linter errors ‚úÖ
- 100% type hints ‚úÖ

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [ADR-001: Database and Migrations](../adr/001-database-and-migrations.md)
- [Roadmap - SPRINT-1](../roadmap.md)
- [Technical Vision](../vision.md)
- [Project Idea](../idea.md)
- [README](../../README.md)

---

**–í–µ—Ä—Å–∏—è:** 1.0
**–°–æ–∑–¥–∞–Ω:** 2025-10-16
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Completed
**–ê–≤—Ç–æ—Ä:** AI Assistant & User
