---
alwaysApply: false
---
# Conventions - –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞

> **–ë–∞–∑–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç:** [vision.md](../../docs/vision.md) - –ø–æ–ª–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

## –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### KISS (Keep It Simple, Stupid)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–∏–∫–∞–∫–æ–≥–æ –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞
- –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π –∫–æ–¥ –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
- –ü—Ä–æ—Å—Ç—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è MVP

### –û–û–ü: 1 –∫–ª–∞—Å—Å = 1 —Ñ–∞–π–ª
- **–ñ–µ—Å—Ç–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
- –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –∫–ª–∞—Å—Å–∞ –≤ snake_case
- –û–¥–∏–Ω –∫–ª–∞—Å—Å = –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- –ù–∏–∫–∞–∫–∏—Ö –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ

### –ú–∏–Ω–∏–º–∞–ª–∏–∑–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∫–ª–∞—Å—Å–∞–º–∏
- –ú–∏–Ω–∏–º—É–º –º–µ—Ç–æ–¥–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
- –ù–∏–∫–∞–∫–∏—Ö —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: TelegramBot ‚Üí ConversationManager ‚Üí LLMClient

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
```
src/
‚îú‚îÄ‚îÄ telegram_bot.py          # –ö–ª–∞—Å—Å TelegramBot
‚îú‚îÄ‚îÄ llm_client.py           # –ö–ª–∞—Å—Å LLMClient
‚îú‚îÄ‚îÄ conversation_manager.py # –ö–ª–∞—Å—Å ConversationManager
‚îú‚îÄ‚îÄ config.py               # –ö–ª–∞—Å—Å Config
‚îî‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```

### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–æ–≤
- **TelegramBot** - —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞ —Å Telegram API (aiogram)
- **LLMClient** - —Ç–æ–ª—å–∫–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å OpenRouter —á–µ—Ä–µ–∑ openai client
- **ConversationManager** - —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–º –∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
- **Config** - —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ .env

### –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main.py)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å API - **async/await**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ aiogram 3.x
- –ù–∏–∫–∞–∫–∏—Ö –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–µ–º **@dataclass** –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
- Dataclass-—ã —Ä–∞–∑–º–µ—â–∞–µ–º –≤ conversation_manager.py
- –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤)
- –°–º. [vision.md](../../docs/vision.md) –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ù–∏–∫–∞–∫–∏—Ö retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ (—Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- Try/catch –Ω–∞ —É—Ä–æ–≤–Ω–µ main.py

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ **.env** —Ñ–∞–π–ª
- –ò—Å–ø–æ–ª—å–∑—É–µ–º **python-dotenv**
- –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
TELEGRAM_BOT_TOKEN=...
OPENROUTER_API_KEY=...
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- –ö–æ–Ω—Å–æ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∏–∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤)
- –§–æ—Ä–º–∞—Ç: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
- –£—Ä–æ–≤–Ω–∏: INFO –¥–ª—è —Ä–∞–±–æ—Ç—ã, ERROR –¥–ª—è –æ—à–∏–±–æ–∫
- **–ù–µ –ª–æ–≥–∏—Ä—É–µ–º:** —Ç–æ–∫–µ–Ω—ã, –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)

### –ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
- –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (user_id, –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞)
- –ó–∞–ø—Ä–æ—Å—ã –∫ LLM (–º–æ–¥–µ–ª—å, –≤—Ä–µ–º—è)
- –û—à–∏–±–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è MVP

- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö **—Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏** (–Ω–∏–∫–∞–∫–∏—Ö –ë–î)
- –ú–∞–∫—Å–∏–º—É–º **10 —Å–æ–æ–±—â–µ–Ω–∏–π** –≤ –∏—Å—Ç–æ—Ä–∏–∏
- **–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ** —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–¥–∏–Ω –¥–∏–∞–ª–æ–≥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏

## –†–∞–±–æ—Ç–∞ —Å LLM

### OpenRouter —á–µ—Ä–µ–∑ openai client
```python
# –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
base_url = "https://openrouter.ai/api/v1"
api_key = config.openrouter_key
model = "openai/gpt-3.5-turbo"
max_tokens = 1000
temperature = 0.7
```

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
```python
messages = [
    {"role": "system", "content": system_prompt},
    {"role": "user", "content": message_text},
    {"role": "assistant", "content": response_text},
    # ... –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
]
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
- `/start` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- `/help` - —Å–ø—Ä–∞–≤–∫–∞
- `/clear` - –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –õ—é–±–æ–π —Ç–µ–∫—Å—Ç - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ LLM

## –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ
- –ö–ª–∞—Å—Å—ã: `PascalCase`
- –ú–µ—Ç–æ–¥—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏: `snake_case`
- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: `UPPER_SNAKE_CASE`
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `snake_case`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ö—Ä–∞—Ç–∫–∏–µ docstring –¥–ª—è –∫–ª–∞—Å—Å–æ–≤
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å self-explanatory

### Python —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **Python 3.11+**
- Type hints –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- –°–ª–µ–¥—É–µ–º PEP 8

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### Ruff (—Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä + –ª–∏–Ω—Ç–µ—Ä)
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** `make format` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **–õ–∏–Ω—Ç–∏–Ω–≥:** `make lint` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ –∏ —Å—Ç–∏–ª—å
- **–ü—Ä–∞–≤–∏–ª–∞:** E, W, F, I, N, B, UP, C90
- **Line length:** 100 —Å–∏–º–≤–æ–ª–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** `ruff check --fix`

### Mypy (type checker)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤:** `make typecheck`
- **–†–µ–∂–∏–º:** strict (disallow_untyped_defs = true)
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å type hints
- **–¶–µ–ª—å:** 100% type coverage

### Pytest (—Ç–µ—Å—Ç—ã)
- **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:** `make test`
- **Coverage:** —Ü–µ–ª—å >80%
- **Async —Ç–µ—Å—Ç—ã:** pytest-asyncio
- **–ú–æ–∫–∏:** unittest.mock –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
make quality  # format + lint + typecheck + test
```

### Workflow –ø—Ä–æ–≤–µ—Ä–æ–∫
1. –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥
2. `make format` - –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. `make lint` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏
4. `make typecheck` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã
5. `make test` - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
6. `make quality` - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤
```
tests/
‚îú‚îÄ‚îÄ conftest.py          # –§–∏–∫—Å—Ç—É—Ä—ã pytest
‚îú‚îÄ‚îÄ test_config.py       # –¢–µ—Å—Ç—ã –¥–ª—è config.py
‚îú‚îÄ‚îÄ test_llm_client.py   # –¢–µ—Å—Ç—ã –¥–ª—è llm_client.py
‚îî‚îÄ‚îÄ ...
```

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
- –§–∞–π–ª—ã: `test_<module_name>.py`
- –§—É–Ω–∫—Ü–∏–∏: `test_<what_is_tested>`
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–Ω—è—Ç–Ω—ã–µ –∏–º–µ–Ω–∞, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–π

### –§–∏–∫—Å—Ç—É—Ä—ã
- `conftest.py` - –æ–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
- `monkeypatch` - –¥–ª—è –ø–æ–¥–º–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **Arrange-Act-Assert** - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –¥–µ–π—Å—Ç–≤–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞
- **–û–¥–∏–Ω —Ç–µ—Å—Ç = –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π**
- **–Ø–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö** - –∏—Å–ø–æ–ª—å–∑—É–µ–º match –≤ pytest.raises
- **–ò–∑–æ–ª—è—Ü–∏—è** - —Ç–µ—Å—Ç—ã –Ω–µ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
- **–ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–æ–∫–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (load_dotenv, API –∏ —Ç.–¥.)

### –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞
```python
def test_config_invalid_max_tokens(valid_env, monkeypatch):
    """–¢–µ—Å—Ç: ValueError –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º MAX_TOKENS"""
    # Arrange
    monkeypatch.setenv("MAX_TOKENS", "not_a_number")
    
    # Act & Assert
    with pytest.raises(ValueError, match="MAX_TOKENS –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º"):
        Config()
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ async –∫–æ–¥–∞

#### pytest-asyncio
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `@pytest.mark.asyncio` –¥–ª—è async —Ñ—É–Ω–∫—Ü–∏–π
- –§–∏–∫—Å—Ç—É—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å async
- AsyncMock –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è async –º–µ—Ç–æ–¥–æ–≤

#### –ü—Ä–∏–º–µ—Ä async —Ç–µ—Å—Ç–∞
```python
@pytest.mark.asyncio
async def test_get_response_success(llm_client: LLMClient) -> None:
    """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM"""
    # Arrange: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ mock –æ—Ç–≤–µ—Ç–∞
    mock_message = Mock()
    mock_message.content = "Test response from LLM"
    
    mock_choice = Mock()
    mock_choice.message = mock_message
    
    mock_usage = Mock()
    mock_usage.total_tokens = 50
    
    mock_response = Mock()
    mock_response.choices = [mock_choice]
    mock_response.usage = mock_usage
    
    # Act: –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ async –≤—ã–∑–æ–≤–∞ API
    with patch.object(
        llm_client.client.chat.completions, "create", new_callable=AsyncMock
    ) as mock_create:
        mock_create.return_value = mock_response
        
        messages = [{"role": "user", "content": "Hello"}]
        result = await llm_client.get_response(messages)
        
        # Assert
        assert result == "Test response from LLM"
        mock_create.assert_called_once_with(
            model="test-model",
            messages=messages,
            max_tokens=100,
            temperature=0.7,
        )
```

### –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö API

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è
1. **Unit —Ç–µ—Å—Ç—ã** - –º–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. **AsyncMock** –¥–ª—è async –º–µ—Ç–æ–¥–æ–≤
3. **patch.object** –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–π –ø–æ–¥–º–µ–Ω—ã
4. **side_effect** –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –æ—à–∏–±–æ–∫

#### –ü—Ä–∏–º–µ—Ä –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è API –æ—à–∏–±–∫–∏
```python
@pytest.mark.asyncio
async def test_get_response_api_error(llm_client: LLMClient) -> None:
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ API"""
    with patch.object(
        llm_client.client.chat.completions, "create", new_callable=AsyncMock
    ) as mock_create:
        # –°–∏–º—É–ª–∏—Ä—É–µ–º API –æ—à–∏–±–∫—É
        mock_create.side_effect = Exception("API Error: Rate limit exceeded")
        
        messages = [{"role": "user", "content": "Hello"}]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
        with pytest.raises(Exception, match="API Error: Rate limit exceeded"):
            await llm_client.get_response(messages)
```

#### –ü—Ä–∏–º–µ—Ä –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ main()
```python
@pytest.mark.asyncio
async def test_main_success() -> None:
    """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    with (
        patch("src.main.Config") as mock_config_class,
        patch("src.main.LLMClient") as mock_llm_class,
        patch("src.main.ConversationManager") as mock_conv_class,
        patch("src.main.TelegramBot") as mock_bot_class,
    ):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock Config
        mock_config = Mock()
        mock_config.openrouter_key = "test-key"
        mock_config.default_model = "test-model"
        mock_config_class.return_value = mock_config
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mock TelegramBot
        mock_bot = Mock()
        mock_bot.start_polling = AsyncMock(side_effect=KeyboardInterrupt())
        mock_bot.stop = AsyncMock()
        mock_bot_class.return_value = mock_bot
        
        # Act
        await main()
        
        # Assert
        mock_config_class.assert_called_once()
        mock_llm_class.assert_called_once()
        mock_bot.stop.assert_called_once()
```

### Coverage –º–µ—Ç—Ä–∏–∫–∏
- **–¶–µ–ª—å:** >80% –æ–±—â–∏–π coverage
- **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:** pytest-cov
- **–û—Ç—á–µ—Ç:** `make test` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç coverage —Å missing lines
- **HTML –æ—Ç—á–µ—Ç:** `pytest --cov=src --cov-report=html` (–≤ htmlcov/)

#### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è coverage
- **100%** - –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏ (config, models)
- **>90%** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (llm_client, conversation_manager)
- **>80%** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ (telegram_bot, main)
- **–ü—Ä–æ–ø—É—Å–∫–∞–µ–º:** `if __name__ == "__main__"`, entry points

## SOLID –ø—Ä–∏–Ω—Ü–∏–ø—ã

### Single Responsibility Principle (SRP)
**–ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.**

#### –ü—Ä–∏–º–µ—Ä —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: ConversationManager

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ SRP):**
```python
class ConversationManager:
    """–£–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∏–∞–ª–æ–≥–æ–º, —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"""
    def __init__(self, llm_client, system_prompt, max_history=10):
        self.contexts: dict[int, ConversationContext] = {}  # –•—Ä–∞–Ω–µ–Ω–∏–µ
        
    def add_user_message(self, user_id, text):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + –æ–±—Ä–µ–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏"""
        # 142 —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ —Å 3 —Ä–∞–∑–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—è–º–∏
        
    def get_messages_for_llm(self, user_id) -> list[dict]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è API"""
        # –ï—â–µ –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
```

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (—Å–æ–±–ª—é–¥–µ–Ω–∏–µ SRP):**
```python
# 1. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (models.py)
@dataclass
class ConversationContext:
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö"""
    user_id: int
    messages: list[UserMessage]
    responses: list[LLMResponse]
    system_prompt: str

# 2. –•—Ä–∞–Ω–∏–ª–∏—â–µ (history_storage.py)
class HistoryStorage:
    """–¢–æ–ª—å–∫–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π"""
    def add_message(self, user_id, text, system_prompt): ...
    def get_context(self, user_id): ...
    def _trim_history(self, user_id): ...

# 3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (message_formatter.py)
class MessageFormatter:
    """–¢–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è API"""
    @staticmethod
    def format_for_llm(context, system_prompt) -> list[dict]: ...

# 4. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (conversation_manager.py)
class ConversationManager:
    """–¢–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
    def __init__(self, llm_client, system_prompt, max_history):
        self.storage = HistoryStorage(max_history)
        self.formatter = MessageFormatter()
    
    async def process_message(self, user_id, text) -> str:
        self.storage.add_message(user_id, text, self.system_prompt)
        context = self.storage.get_context(user_id)
        messages = self.formatter.format_for_llm(context, self.system_prompt)
        return await self.llm_client.get_response(messages)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–æ–¥ —Å–æ–∫—Ä–∞—Ç–∏–ª—Å—è —Å 142 –¥–æ 92 —Å—Ç—Ä–æ–∫
- ‚úÖ –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –¥—Ä—É–≥–∏–µ
- ‚úÖ Coverage: 100% –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### Don't Repeat Yourself (DRY)
**–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è - –∫–∞–∂–¥–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–µ.**

#### –ü—Ä–∏–º–µ—Ä —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: TelegramBot

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ DRY):**
```python
async def cmd_start(self, message: Message):
    user_id = message.from_user.id  # –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 4 —Ä–∞–∑–∞
    username = message.from_user.username or message.from_user.first_name
    logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /start –æ—Ç user {user_id} (@{username})")
    
    welcome_text = (  # –î–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ–¥–µ
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø LLM-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç...\n\n"
        "–Ø –º–æ–≥—É:\n"
        # ... 20 —Å—Ç—Ä–æ–∫ —Ç–µ–∫—Å—Ç–∞
    )
    await message.answer(welcome_text)

async def cmd_help(self, message: Message):
    user_id = message.from_user.id  # –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
    username = message.from_user.username or message.from_user.first_name
    # ... –∏ —Ç–∞–∫ –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ
```

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (—Å–æ–±–ª—é–¥–µ–Ω–∏–µ DRY):**
```python
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
WELCOME_TEXT = """üëã –ü—Ä–∏–≤–µ—Ç! –Ø LLM-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç..."""
HELP_TEXT = """‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é..."""
ERROR_MESSAGE_GENERAL = """‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞..."""

class TelegramBot:
    def _get_user_info(self, message: Message) -> tuple[int, str]:
        """–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è user info"""
        if not message.from_user:
            raise ValueError("Message has no user information")
        
        user_id = message.from_user.id
        username = message.from_user.username or message.from_user.first_name or "Unknown"
        return user_id, username
    
    async def cmd_start(self, message: Message) -> None:
        user_id, username = self._get_user_info(message)  # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
        logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /start –æ—Ç user {user_id} (@{username})")
        await message.answer(WELCOME_TEXT)  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞
    
    async def cmd_help(self, message: Message) -> None:
        user_id, username = self._get_user_info(message)  # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
        logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /help –æ—Ç user {user_id} (@{username})")
        await message.answer(HELP_TEXT)  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–æ–¥ —Å—Ç–∞–ª –∫–æ—Ä–æ—á–µ –∏ —á–∏—â–µ
- ‚úÖ Type hints –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤–µ–∑–¥–µ (`-> None`, `-> tuple[int, str]`)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å `message.from_user` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ None)
- ‚úÖ –õ–µ–≥–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ - —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ Coverage: 94% –¥–ª—è telegram_bot.py

## CI/CD

### GitHub Actions

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –∏ PR:

**–§–∞–π–ª:** `.github/workflows/quality.yml`

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Push –≤ –≤–µ—Ç–∫–∏: main, develop, day03-refactor
- Pull Request –≤: main, develop

**–®–∞–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```yaml
1. Setup: uv + Python 3.11
2. Install: uv sync --dev
3. Format check: ruff format src/ --check
4. Lint: ruff check src/
5. Typecheck: mypy src/
6. Tests: pytest --cov=src --cov-report=xml
```

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ push

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ:**
```bash
make quality  # –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–æ–º
```

–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ **–±–µ–∑ –æ—à–∏–±–æ–∫** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º PR.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ PR

- ‚úÖ All checks passed –≤ GitHub Actions
- ‚úÖ Coverage –Ω–µ —É–ø–∞–ª (<95% —Ç–µ–∫—É—â–∏–π)
- ‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞/mypy
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã passed
- ‚úÖ Type hints –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### Badges –≤ README

–ò—Å–ø–æ–ª—å–∑—É–µ–º badges –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:

```markdown
![Python Version](https://img.shields.io/badge/python-3.11+-blue.svg)
![CI Status](https://img.shields.io/badge/CI-passing-brightgreen.svg)
![Coverage](https://img.shields.io/badge/coverage-95%25-brightgreen.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
```

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ CI failed

**Format check failed:**
```bash
make format
git add .
git commit --amend --no-edit
git push --force-with-lease
```

**Lint/typecheck failed:**
```bash
make lint
make typecheck
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏
git add .
git commit --amend --no-edit
git push --force-with-lease
```

**Tests failed:**
```bash
make test
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –∏–ª–∏ –∫–æ–¥
git add .
git commit --amend --no-edit
git push --force-with-lease
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ CI/CD

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º push
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ merge –∫–æ–¥–∞ —Å –æ—à–∏–±–∫–∞–º–∏
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ PR
- ‚úÖ –í–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ badges
- ‚úÖ –ï–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

---

**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-10-11 (–¥–æ–±–∞–≤–ª–µ–Ω CI/CD —Ä–∞–∑–¥–µ–ª)

